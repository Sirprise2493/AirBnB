<% listing = booking.listing %>
<% collapse_id = "review-form-#{booking.id}" %>

<div class="col">
  <div class="bookings-made-by-aourself bookings-made-by-yourself">
    <div class="booking-card-wrapper booking-card--profile">
      <div class="card booking-card h-100 shadow-sm border-0">
        <%# Image %>
        <% if listing.respond_to?(:photos) && listing.photos.attached? %>
          <%= image_tag listing.photos.first, class: "card-img-top booking-card__img", alt: listing.title %>
        <% else %>
          <div class="booking-card__img placeholder d-flex align-items-center justify-content-center">
            <span class="text-muted">No image</span>
          </div>
        <% end %>

        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-start justify-content-between mb-2">
            <h5 class="card-title mb-0"><%= listing.title %></h5>
            <% label, bs = booking_status_badge(booking) %>
            <span class="badge text-bg-<%= bs %>"><%= label %></span>
          </div>

          <% nights = (booking.end_date - booking.start_date).to_i rescue nil %>

          <ul class="list-unstyled small text-muted mb-3">
            <li><strong>Dates:</strong> <%= l booking.start_date %> – <%= l booking.end_date %> <% if nights && nights > 0 %>(<%= nights %> nights)<% end %></li>
            <li><strong>Guests:</strong> <%= booking.number_guests %></li>
            <% if booking.total_price.present? %>
              <li><strong>Total:</strong> <%= number_to_currency(booking.total_price, unit: "€") %></li>
            <% end %>
            <li><strong>Booked:</strong> <%= l booking.created_at.to_date %></li>
          </ul>

          <div class="mt-auto d-flex flex-wrap gap-2">
            <%= link_to "Show listing", listing_path(listing), class: "btn btn-success btn-sm" %>

            <%= button_to "Delete",
                          booking_path(booking),
                          method: :delete,
                          data: { turbo_confirm: "Are you sure?" },
                          class: "btn btn-danger btn-sm" %>

            <button class="btn btn-primary btn-sm"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="##{collapse_id}"
                    aria-expanded="false"
                    aria-controls="<%= collapse_id %>">
              Give a review
            </button>
          </div>

          <div class="collapse mt-3" id="<%= collapse_id %>">
            <%= render "listings/reviews/review_create_form",
                       listing: listing,
                       review: Review.new,
                       return_to: user_profile_path %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
