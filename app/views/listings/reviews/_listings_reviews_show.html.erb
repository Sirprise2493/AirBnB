<section class="listing-reviews" id="reviews">
  <div class="head">
    <div class="score">
      <span class="number"><%= avg_rate %></span>
      <span class="star">★</span>
    </div>

    <p class="subtitle">
      <%= pluralize(reviews.respond_to?(:total_count) ? reviews.total_count : reviews.size, "review") %>
      for “<%= listing.title %>”
    </p>

    <div class="avg-stars" aria-label="Average rating <%= avg_rate %> out of 5">
      <% filled = avg_rate.floor %>
      <% 1.upto(5) do |i| %>
        <span class="star <%= i <= filled ? 'filled' : 'empty' %>">★</span>
      <% end %>
    </div>

    <div class="mt-3">
      <%= link_to "Create review",
                  "#new-review",
                  class: "btn btn-outline-primary",
                  data: { bs_toggle: "collapse" },
                  role: "button",
                  aria_controls: "new-review",
                  aria_expanded: "false" %>
    </div>

    <!-- Collapsible Form -->
    <div id="new-review" class="collapse mt-3">
      <%= render partial: "listings/reviews/review_create_form",
                 locals: { listing: listing, review: (defined?(review) && review) || Review.new } %>
    </div>
  </div>

  <% if reviews.present? %>
    <div class="grid">
      <% reviews.each do |rev| %>
        <article class="card">
          <header class="card-head">
            <% if rev.user&.photo.present? %>
              <%= cl_image_tag rev.user.photo.key,
                    class: "avatar", width: 48, height: 48, crop: :thumb, gravity: :face %>
            <% else %>
              <div class="avatar placeholder" aria-hidden="true"></div>
            <% end %>

            <div class="who">
              <div class="name"><%= [rev.user&.first_name, rev.user&.last_name].compact.join(" ") %></div>
              <div class="meta"><%= relative_time_for(rev.created_at) %></div>
            </div>
          </header>

          <div class="stars" aria-label="Rating: <%= rev.rating %> out of 5">
            <% 1.upto(5) do |i| %>
              <span class="star <%= i <= rev.rating.to_i ? 'filled' : 'empty' %>">★</span>
            <% end %>
          </div>

          <p class="content"><%= simple_format(h(rev.content)) %></p>
        </article>
      <% end %>
    </div>

    <div class="mt-4">
      <%= paginate reviews %>
    </div>
  <% else %>
    <p class="text-muted mt-3">Noch keine Reviews.</p>
  <% end %>
</section>
